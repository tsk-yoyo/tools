(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,56357,e=>{"use strict";var r=e.i(43476),t=e.i(71645),a=e.i(18566);let n=(0,e.i(75254).default)("settings",[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);var l=e.i(37727);function o({isOpen:e,onClose:t,onToggle:a,children:o,title:c="Settings"}){return(0,r.jsxs)(r.Fragment,{children:[!e&&(0,r.jsx)("button",{onClick:a,className:"fixed top-4 right-4 z-30 p-3 bg-surface-light dark:bg-gray-800 rounded-full shadow-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors","aria-label":"Open settings",children:(0,r.jsx)(n,{size:24})}),e&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 z-30",onClick:t}),(0,r.jsx)("div",{className:`
          fixed top-0 right-0 h-full w-full sm:w-96 bg-surface-light dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 shadow-2xl z-40
          transition-transform duration-300 ease-in-out
          ${e?"translate-x-0":"translate-x-full"}
        `,children:(0,r.jsxs)("div",{className:"flex flex-col h-full",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700",children:[(0,r.jsxs)("h2",{className:"text-xl font-bold flex items-center gap-2 ml-12 lg:ml-0",children:[(0,r.jsx)(n,{size:24}),c]}),(0,r.jsx)("button",{onClick:t,className:"p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors","aria-label":"Close settings",children:(0,r.jsx)(l.X,{size:24})})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto p-6",children:o})]})})]})}function c({delayMs:e,isMirrored:a,isRunning:n,isMaximized:l,onToggleMaximize:o,onStatusChange:c,onError:s}){let i,u,d,g,h,p,m,f,b,y,w,v,x,k,S,j,M,C,R=(0,t.useRef)(null),{start:N,stop:E}=(i=(0,t.useRef)(null),u=(0,t.useRef)(null),d=(0,t.useRef)(null),g=(0,t.useRef)([]),h=(0,t.useRef)([]),p=(0,t.useRef)(!1),m=(0,t.useRef)(0),f=(0,t.useRef)(null),b=(0,t.useRef)(null),y=(0,t.useRef)(null),w=(0,t.useRef)(null),v=(0,t.useCallback)(()=>"ManagedMediaSource"in window?window.ManagedMediaSource:"u">typeof MediaSource?MediaSource:null,[]),x=(0,t.useCallback)(()=>{let e=v();if(!e)return null;for(let r of["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"]){let t="u">typeof MediaRecorder&&MediaRecorder.isTypeSupported(r),a=e.isTypeSupported(r);if(t&&a)return console.warn(`Using codec: ${r}`),r}return null},[v]),k=(0,t.useCallback)(()=>{let e=d.current,r=u.current;if(!e||e.updating||p.current||0===h.current.length)return;let t=h.current.shift();t&&(p.current=!0,t.arrayBuffer().then(t=>{if(!e||!r||"open"!==r.readyState){p.current=!1;return}try{e.appendBuffer(t)}catch(e){console.error("Failed to append buffer:",e),p.current=!1}}).catch(e=>{console.error("Failed to convert chunk:",e),p.current=!1}))},[]),S=(0,t.useCallback)(()=>{let e=Date.now(),r=m.current;for(;g.current.length>0;)if(e-g.current[0].timestamp>=r){let e=g.current.shift();e&&(h.current.push(e.data),h.current.length>50&&h.current.shift())}else break;k()},[k]),j=(0,t.useCallback)(async e=>{let r=e.getVideoTracks()[0];if(!r)return e;let t=r.getSettings(),a=t.width||1280,n=t.height||720,l=y.current;if(l){y.current=null;try{l.pause(),l.srcObject=null}catch{}}let o=document.createElement("canvas");o.width=a,o.height=n,b.current=o;let c=o.getContext("2d",{alpha:!1});if(!c)return e;let s=document.createElement("video");s.srcObject=e,s.muted=!0,s.playsInline=!0,await s.play(),await new Promise(e=>{let r=()=>{s.readyState>=s.HAVE_CURRENT_DATA?e():requestAnimationFrame(r)};r()}),y.current=s;let i=()=>{s.readyState>=s.HAVE_CURRENT_DATA&&(c.save(),c.scale(-1,1),c.drawImage(s,-a,0,a,n),c.restore()),w.current=requestAnimationFrame(i)};i();let u=o.captureStream(30);return e.getAudioTracks().forEach(e=>{u.addTrack(e)}),u},[]),M=(0,t.useCallback)((e,r,t)=>new Promise((a,n)=>{let l=v();if(!l)return void n(Error("MediaSource not available"));let o=new l;u.current=o,m.current=e;let c=URL.createObjectURL(o);console.warn("Created objectURL:",c),t.srcObject=null,t.src=c,t.play().catch(e=>{console.warn("Autoplay error:",e.message)}),console.warn("Set video.src to objectURL and called play()"),o.addEventListener("sourceopen",()=>{console.warn("MediaSource sourceopen event fired");try{let e=o.addSourceBuffer(r);e.mode="sequence",d.current=e,e.addEventListener("updateend",()=>{p.current=!1,k()}),e.addEventListener("error",e=>{console.error("SourceBuffer error:",e)}),"ManagedMediaSource"in window&&o.startStreaming?.(),console.warn("MediaSource setup complete"),a()}catch(e){n(e)}}),o.addEventListener("sourceended",()=>{console.warn("MediaSource ended")}),o.addEventListener("sourceclose",()=>{console.warn("MediaSource closed")})}),[v,k]),C=(0,t.useCallback)(async(e,r,t)=>{if(console.warn("MediaSourceRecorder.start called",{delayMs:r,isMirrored:t,hasVideoRef:!!R.current}),i.current?.state==="recording"&&(console.warn("Stopping existing MediaRecorder before starting new one"),i.current.stop(),i.current=null),u.current?.readyState==="open"){console.warn("Closing existing MediaSource before starting new one");try{u.current.endOfStream()}catch{}u.current=null}null!==w.current&&(cancelAnimationFrame(w.current),w.current=null),b.current&&(b.current=null),f.current=e;let a=t?await j(e):e;if(0===r){if(console.warn("Using direct stream (delay=0)"),R.current){try{R.current.pause()}catch{}R.current.srcObject=a,R.current.play().catch(e=>{"AbortError"!==e.name&&console.error("Failed to start video playback:",e)})}return}console.warn("Using MediaRecorder + MediaSource (delay>0)");let n=x();if(!n)throw Error("No supported codec found");if(console.warn("Using mimeType:",n),!R.current)throw Error("Video element not available");m.current=r,await M(r,n,R.current),console.warn("MediaSource setup complete"),g.current=[],h.current=[],p.current=!1;let l=new MediaRecorder(a,{mimeType:n});i.current=l,l.ondataavailable=e=>{e.data&&e.data.size>0&&(g.current.push({data:e.data,timestamp:Date.now()}),g.current.length>100&&g.current.shift(),S())},l.start(250),console.warn("MediaRecorder started")},[x,M,S,R,j]),{start:C,stop:(0,t.useCallback)(()=>{i.current?.state==="recording"&&i.current.stop(),u.current?.readyState==="open"&&u.current.endOfStream(),R.current&&(R.current.pause(),R.current.src="",R.current.srcObject=null),null!==w.current&&(cancelAnimationFrame(w.current),w.current=null),y.current&&(y.current.pause(),y.current.srcObject=null,y.current=null),b.current&&(b.current=null),f.current&&(f.current.getTracks().forEach(e=>e.stop()),f.current=null),i.current=null,u.current=null,d.current=null,g.current=[],h.current=[],p.current=!1},[R]),isSupported:(0,t.useCallback)(()=>!!v()&&null!==x(),[v,x])});return(0,t.useEffect)(()=>{if(n)return(async()=>{try{R.current||await new Promise(e=>{let r=()=>{R.current?e():requestAnimationFrame(r)};r()}),c?.("Requesting camera access...");let r=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:!1});c?.(0===e?"Recording (live view)":`Recording (delay: ${e}ms) - MediaSource mode`),await N(r,e,a)}catch(r){let e=r instanceof Error?r.message:"Failed to start recording";console.error("MediaSourceVideo error:",r),s?.(r instanceof Error?r:Error(e))}})(),()=>{E()}},[n]),(0,r.jsxs)("div",{className:l?"fixed inset-0 z-[70] bg-black":"relative bg-black rounded-lg overflow-hidden aspect-video shadow-2xl",children:[(0,r.jsx)("video",{ref:R,autoPlay:!0,muted:!0,playsInline:!0,controls:!0,className:"w-full h-full object-contain"}),l&&(0,r.jsx)("button",{onClick:o,className:"absolute top-4 right-4 p-2 bg-surface-light bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 rounded-lg hover:bg-opacity-100 transition-opacity shadow-lg z-[70]",title:"Exit Fullscreen",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,r.jsx)("path",{d:"M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"})})}),n&&!l&&(0,r.jsx)("button",{onClick:o,className:"absolute top-4 right-4 p-2 bg-surface-light bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 rounded-lg hover:bg-opacity-100 transition-opacity shadow-lg z-[30]",title:"Fullscreen",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,r.jsx)("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})})})]})}function s({delayMs:e,isMirrored:a,isRunning:n,isMaximized:l,onToggleMaximize:o,onStatusChange:c,onError:s}){let i,u,d,g,h,p,m,f,b,y=(0,t.useRef)(null),w=(0,t.useRef)(null),{start:v,stop:x}=(i=(0,t.useRef)(null),u=(0,t.useRef)(null),d=(0,t.useRef)(null),g=(0,t.useRef)([]),h=(0,t.useRef)(null),p=(0,t.useRef)(0),m=(0,t.useRef)(!1),f=(0,t.useCallback)(()=>{let e=i.current,r=u.current;if(!e||!r||e.readyState<2)return;let t=r.getContext("2d",{willReadFrequently:!0});if(!t)return;t.drawImage(e,0,0,r.width,r.height);let a=t.getImageData(0,0,r.width,r.height);g.current.push({imageData:a,timestamp:Date.now()});let n=Math.ceil((p.current+15e3)/33);g.current.length>n&&g.current.shift()},[]),b=(0,t.useCallback)(()=>{let e=()=>{if(!m.current)return;let r=Date.now(),t=p.current,a=y.current;if(!a){h.current=requestAnimationFrame(e);return}let n=a.getContext("2d");if(!n){h.current=requestAnimationFrame(e);return}let l=null,o=-1;for(let e=0;e<g.current.length;e++)if(r-g.current[e].timestamp>=t)l=g.current[e],o=e;else break;l&&(n.putImageData(l.imageData,0,0),o>0&&g.current.splice(0,o)),h.current=requestAnimationFrame(e)};e()},[y]),{start:(0,t.useCallback)((e,r)=>{console.warn("CanvasRecorder.start called",{delayMs:r,hasCanvasRef:!!y.current}),p.current=r,m.current=!0;let t=document.createElement("video");t.srcObject=e,t.autoplay=!0,t.muted=!0,t.playsInline=!0,i.current=t;let a=document.createElement("canvas");u.current=a,t.onloadedmetadata=()=>{console.warn("Source video metadata loaded",{width:t.videoWidth,height:t.videoHeight}),a.width=t.videoWidth||1280,a.height=t.videoHeight||720,y.current?(y.current.width=a.width,y.current.height=a.height,console.warn("Display canvas dimensions set")):console.error("canvasRef.current is null!"),t.play().then(()=>{g.current=[],d.current=window.setInterval(()=>{f()},33),b()})}},[f,b,y]),stop:(0,t.useCallback)(()=>{if(m.current=!1,null!==d.current&&(clearInterval(d.current),d.current=null),null!==h.current&&(cancelAnimationFrame(h.current),h.current=null),i.current){let e=i.current.srcObject;e&&e.getTracks().forEach(e=>e.stop()),i.current.srcObject=null,i.current=null}u.current=null,g.current=[]},[])});return(0,t.useEffect)(()=>{if(n)return(async()=>{try{y.current||await new Promise(e=>{let r=()=>{y.current?e():requestAnimationFrame(r)};r()}),c?.("Requesting camera access...");let r=await navigator.mediaDevices.getUserMedia({video:{width:1280,height:720},audio:!1});w.current=r,c?.(`Recording (delay: ${e}ms) - Canvas mode`),v(r,e)}catch(r){let e=r instanceof Error?r.message:"Failed to start recording";console.error("CanvasDisplay error:",r),s?.(r instanceof Error?r:Error(e))}})(),()=>{x(),w.current&&(w.current.getTracks().forEach(e=>e.stop()),w.current=null)}},[n]),(0,r.jsxs)("div",{className:l?"fixed inset-0 z-[70] bg-black":"relative bg-black rounded-lg overflow-hidden aspect-video shadow-2xl",children:[(0,r.jsx)("canvas",{ref:y,className:"w-full h-full object-contain",style:{transform:a?"scaleX(-1)":"none"}}),l&&(0,r.jsx)("button",{onClick:o,className:"absolute top-4 right-4 p-2 bg-surface-light bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 rounded-lg hover:bg-opacity-100 transition-opacity shadow-lg z-[70]",title:"Exit Fullscreen",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,r.jsx)("path",{d:"M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"})})}),n&&!l&&(0,r.jsx)("button",{onClick:o,className:"absolute top-4 right-4 p-2 bg-surface-light bg-opacity-90 dark:bg-gray-800 dark:bg-opacity-90 rounded-lg hover:bg-opacity-100 transition-opacity shadow-lg z-[30]",title:"Fullscreen",children:(0,r.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:(0,r.jsx)("path",{d:"M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"})})})]})}function i(e){return"object"==typeof e&&null!==e&&!(!("delaySec"in e)||"number"!=typeof e.delaySec||isNaN(e.delaySec))&&"isMirrored"in e&&"boolean"==typeof e.isMirrored&&(!("isSettingsOpen"in e)||void 0===e.isSettingsOpen||"boolean"==typeof e.isSettingsOpen)&&!(e.delaySec<0)&&!(e.delaySec>10)}c.displayName="MediaSourceVideo",s.displayName="CanvasDisplay";let u={delaySec:.5,isMirrored:!1,isSettingsOpen:!0};function d(){let e,n,l=(0,a.useSearchParams)().get("mode"),[d,g]=function(e){let{key:r,initialValue:a,validator:n}=e,l=(0,t.useCallback)(()=>{try{let e=window.localStorage.getItem(r);if(null===e)return a;let t=JSON.parse(e);if(n&&!n(t))return console.warn(`[useLocalStorage] Validation failed for key "${r}". Using initial value.`),a;return t}catch(e){return console.warn(`[useLocalStorage] Error reading localStorage key "${r}":`,e),a}},[r,a,n]),[o,c]=(0,t.useState)(l),s=(0,t.useCallback)(e=>{try{let t=e instanceof Function?e(o):e;c(t),window.localStorage.setItem(r,JSON.stringify(t))}catch(e){console.error(`[useLocalStorage] Error saving to localStorage key "${r}":`,e)}},[r,o]),i=(0,t.useCallback)(()=>{s(a)},[a,s]);return(0,t.useEffect)(()=>{c(l())},[l]),[o,s,i]}({key:"mirror-settings",initialValue:u,validator:i}),[h,p]=(0,t.useState)(!1),[m,f]=(0,t.useState)(!1),[b,y]=(0,t.useState)(""),[w,v]=(0,t.useState)(null),[x,k]=(0,t.useState)(0),{getSupportedMode:S}=(e=(0,t.useCallback)(e=>{for(let r of["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm"]){let t="u">typeof MediaRecorder&&MediaRecorder.isTypeSupported(r),a=e.isTypeSupported(r);if(t&&a)return console.warn(`Found supported codec: ${r}`),r}return console.warn("No supported codec found"),null},[]),n=(0,t.useCallback)(()=>{if("ManagedMediaSource"in window)return console.warn("ManagedMediaSource detected - forcing canvas mode (Safari cannot play WebM)"),!1;if("u">typeof MediaSource){let r=e(MediaSource);return console.warn("MediaSource support check:",{mimeType:r,supported:null!==r}),null!==r}return console.warn("MediaSource not available"),!1},[e]),{getSupportedMode:(0,t.useCallback)(e=>0===e||n()?"mediasource":"canvas",[n])}),j=d.delaySec,M=d.isMirrored,C=d.isSettingsOpen??!0,R=(0,t.useCallback)(e=>{g(r=>({...r,delaySec:e}))},[g]),N=(0,t.useCallback)(e=>{g(r=>({...r,isMirrored:e}))},[g]),E=(0,t.useCallback)(e=>{g(r=>({...r,isSettingsOpen:e}))},[g]),F=e=>{y(e)},O=e=>{y(`Error: ${e.message}`),f(!1)},T=()=>{p(!h)},A=()=>{E(!C)};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o,{isOpen:C,onClose:()=>{E(!1)},onToggle:A,title:"Settings",children:(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"space-y-2",children:(0,r.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:M,onChange:e=>N(e.target.checked),disabled:m,className:"w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary disabled:opacity-50"}),(0,r.jsx)("span",{className:"text-sm font-medium",children:"Mirror (Flip Horizontally)"})]})}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("label",{htmlFor:"delay",className:"block text-sm font-medium",children:"Delay Time"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("input",{type:"number",id:"delay",value:j,onChange:e=>R(parseFloat(e.target.value)||0),min:"0",max:"10",step:"0.1",disabled:m,className:"flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-surface-light dark:bg-gray-700 disabled:opacity-50"}),(0,r.jsx)("span",{className:"text-sm text-gray-600 dark:text-gray-400",children:"sec"})]})]}),(0,r.jsxs)("div",{className:"pt-4 dark:border-gray-700 space-y-2",children:[(0,r.jsx)("button",{onClick:()=>{let e=Math.round(1e3*j),r=l||S(e);k(e),v(r),f(!0),E(!1)},disabled:m,className:"w-full px-4 py-3 bg-primary text-white rounded-lg hover:bg-primary-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:"Start"}),(0,r.jsx)("button",{onClick:()=>{f(!1),v(null),p(!1),y("")},disabled:!m,className:"w-full px-4 py-3 bg-danger text-white rounded-lg hover:bg-danger-hover disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium",children:"Stop"})]}),l&&(0,r.jsx)("div",{className:"p-3 bg-yellow-100 dark:bg-yellow-900 rounded-lg",children:(0,r.jsxs)("p",{className:"text-sm text-yellow-800 dark:text-yellow-200 font-medium",children:["Force mode: ",l]})}),b&&(0,r.jsx)("div",{className:"p-3 bg-gray-100 dark:bg-gray-700 rounded-lg",children:(0,r.jsx)("p",{className:"text-sm text-gray-700 dark:text-gray-300",children:b})})]})}),(0,r.jsx)("main",{className:"min-h-screen flex flex-col items-center justify-center p-4 pt-20 lg:pt-4",children:(0,r.jsxs)("div",{className:"w-full max-w-6xl space-y-4",children:["mediasource"===w&&(0,r.jsx)(c,{delayMs:x,isMirrored:M,isRunning:m,isMaximized:h,onToggleMaximize:T,onStatusChange:F,onError:O}),"canvas"===w&&(0,r.jsx)(s,{delayMs:x,isMirrored:M,isRunning:m,isMaximized:h,onToggleMaximize:T,onStatusChange:F,onError:O}),!w&&(0,r.jsx)("div",{onClick:A,className:"relative bg-black rounded-lg overflow-hidden aspect-video shadow-2xl flex items-center justify-center cursor-pointer hover:bg-gray-900 transition-colors",children:(0,r.jsx)("p",{className:"text-white text-lg",children:"Press Start to begin"})})]})})]})}function g(){return(0,r.jsx)(t.Suspense,{fallback:(0,r.jsx)("div",{children:"Loading..."}),children:(0,r.jsx)(d,{})})}e.s(["default",()=>g],56357)}]);